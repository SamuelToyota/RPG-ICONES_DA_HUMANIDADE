{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Ficha do Her√≥i: {{ character.nome_do_heroi }}</title>
    <link rel="stylesheet" href="{% static 'core/style.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --blue: #00a2ff; --purple: #9d4edd; --red: #ff4d4d; --green: #00ff88;
            --bg: #050508; --panel: rgba(20, 20, 25, 0.9);
        }
        body { background: var(--bg); color: #fff; font-family: 'Rajdhani', sans-serif; padding: 20px; }

        .dossier {
            max-width: 1000px; margin: 0 auto; background: var(--panel);
            border: 1px solid #333; padding: 40px; position: relative;
            clip-path: polygon(0 0, 100% 0, 100% 97%, 97% 100%, 0 100%);
        }

        /* Topo */
        .header-box { border-bottom: 2px solid var(--blue); margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end; }
        .header-box h1 { font-family: 'Orbitron'; font-size: 2.5rem; margin: 0; text-transform: uppercase; }

        .btn-scanner {
            background: none; border: 1px solid var(--blue); color: var(--blue);
            font-family: 'Orbitron'; font-size: 0.6rem; cursor: pointer;
            padding: 4px 12px; transition: 0.3s; margin-left: 15px;
        }
        .btn-scanner:hover { background: rgba(0, 162, 255, 0.2); box-shadow: 0 0 10px var(--blue); }

        /* Alertas */
        #scanner-result, #ruptura-result, #skill-detail-box {
            display: none; margin-bottom: 25px; border: 1px dashed var(--red);
            padding: 15px; background: rgba(255, 77, 77, 0.05);
            animation: blink-border 1.5s infinite;
        }
        #ruptura-result { border: 2px solid var(--red); background: rgba(255, 0, 0, 0.15); animation: pulse-red-box 2s infinite; }

        /* Box de Detalhes da Habilidade (Roxo) */
        #skill-detail-box {
            border: 1px solid var(--purple);
            background: rgba(157, 78, 221, 0.1);
            animation: none;
            display: none;
            margin-top: 15px;
        }

        @keyframes blink-border { 50% { border-color: transparent; } }
        @keyframes pulse-red-box { 0% { box-shadow: 0 0 5px var(--red); } 50% { box-shadow: 0 0 20px var(--red); } 100% { box-shadow: 0 0 5px var(--red); } }

        /* Grid Principal */
        .main-grid { display: grid; grid-template-columns: 300px 1fr; gap: 40px; }

        /* Coluna Esquerda */
        .photo-frame { width: 100%; height: 350px; border: 2px solid #333; position: relative; background: #000; overflow: hidden; }
        .photo-frame img { width: 100%; height: 100%; object-fit: cover; }
        .scan-line { position: absolute; width: 100%; height: 2px; background: var(--blue); opacity: 0.5; top: 0; animation: scan 4s linear infinite; }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        .attr-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .attr-item { background: #111; padding: 10px; border: 1px solid #222; text-align: center; }
        .attr-val { display: block; font-family: 'Orbitron'; font-size: 1.5rem; color: var(--blue); }
        .attr-label { font-size: 0.7rem; color: #666; text-transform: uppercase; }

        /* MOMENTUM SLOTS */
        .mom-slot { height: 15px; flex: 1; border: 1px solid #333; background: #111; cursor: pointer; transition: 0.4s; }
        .mom-fill { background: var(--green) !important; box-shadow: 0 0 10px var(--green); border-color: var(--green) !important; }

        /* RUPTURA SLOTS */
        .slot-fuso { width: 100%; height: 12px; border: 1px solid #333; background: #050508; cursor: pointer; transition: 0.3s; }
        .slot-ativo { background: var(--red) !important; box-shadow: 0 0 10px var(--red); border-color: var(--red) !important; }

        .btn-ruptura-ready {
            width: 100%; background: var(--red); color: #000; border: none;
            font-family: 'Orbitron'; font-size: 0.7rem; font-weight: bold;
            padding: 8px; cursor: pointer; margin-top: 10px;
            animation: pulse-btn 1s infinite; display: none;
        }
        @keyframes pulse-btn { 0% { opacity: 0.8; } 50% { opacity: 1; transform: scale(1.02); } 100% { opacity: 0.8; } }

        /* Coluna Direita */
        .section-title { font-family: 'Orbitron'; font-size: 0.9rem; color: var(--blue); margin: 25px 0 15px 0; border-left: 3px solid var(--blue); padding-left: 10px; }
        .bar-container { margin-bottom: 15px; }
        .bar-info { display: flex; justify-content: space-between; font-size: 0.8rem; font-family: 'Orbitron'; margin-bottom: 5px; }
        .bar-bg { width: 100%; height: 12px; background: #111; border: 1px solid #333; border-radius: 2px; }
        .bar-fill { height: 100%; transition: 1s; }

        .tags-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .tag { background: rgba(0, 162, 255, 0.1); border: 1px solid var(--blue); padding: 5px 12px; font-size: 0.8rem; border-radius: 4px; }
        .tag.hab { border-color: var(--purple); color: var(--purple); background: rgba(157, 78, 221, 0.1); cursor: pointer; transition: 0.2s; }
        .tag.hab:hover { background: var(--purple); color: #fff; }

        /* Estilo para a Habilidade de Classe / √çndole */
        .class-skill-box {
            background: rgba(0, 255, 136, 0.05); border: 1px solid var(--green); padding: 15px; margin-top: 10px;
        }

        .trilha-area {
            background: rgba(157, 78, 221, 0.05); border: 1px solid var(--purple); padding: 15px;
            min-height: 100px; font-family: 'Courier New', monospace; color: #ccc;
            font-size: 0.9rem; margin-top: 10px; line-height: 1.4;
        }

        .action-btns { margin-top: 40px; display: flex; gap: 15px; justify-content: flex-end; }
        .btn { font-family: 'Orbitron'; padding: 10px 20px; text-decoration: none; border: 1px solid; transition: 0.3s; font-size: 0.8rem; }
        .btn-edit { color: var(--blue); border-color: var(--blue); }
        .btn-edit:hover { background: var(--blue); color: #000; }
        .btn-del { color: var(--red); border-color: var(--red); }
        .btn-del:hover { background: var(--red); color: #000; }
    </style>
</head>
<body onload="initBars()">

<div class="dossier">
    <div class="header-box">
        <div>
            <div style="color: var(--blue); font-size: 0.8rem; letter-spacing: 4px; display: flex; align-items: center;">
                √çCONES DA HUMANIDADE
                <button type="button" class="btn-scanner" onclick="scanAmbiente()">[ SCANNER DE AMBIENTE ]</button>
            </div>
            <h1>{{ character.nome_do_heroi }}</h1>
        </div>
        <div style="text-align: right;">
            <div style="font-family: 'Orbitron'; font-size: 1.2rem;">LVL {{ character.nivel }}</div>
            <div style="color: #666; font-size: 0.7rem;">ORIGEM: {{ character.get_origem_display }}</div>
        </div>
    </div>

    <div id="scanner-result">
        <div style="font-family: 'Orbitron'; color: var(--red); font-size: 0.8rem; margin-bottom: 5px; letter-spacing: 2px;">‚ö†Ô∏è ANOMALIA DE AMBIENTE DETECTADA:</div>
        <div id="evento-texto" style="font-family: 'Courier New', monospace; color: #fff; font-size: 0.9rem; border-left: 2px solid var(--red); padding-left: 10px;"></div>
    </div>

    <div id="ruptura-result">
        <div style="font-family: 'Orbitron'; color: #fff; font-size: 1rem; text-shadow: 0 0 10px var(--red); margin-bottom: 5px;">üö® PROTOCOLO PROIBIDO ATIVADO:</div>
        <div id="ruptura-texto" style="font-family: 'Courier New', monospace; color: #fff; font-size: 0.9rem; border-left: 2px solid #fff; padding-left: 10px;"></div>
    </div>

    <div class="main-grid">
        <div class="side-col">
            <div class="photo-frame">
                <div class="scan-line"></div>
                {% if character.foto %}
                    <img src="{{ character.foto.url }}">
                {% else %}
                    <div style="text-align:center; padding-top:150px; color:#222;">NO_IMAGE_DATA</div>
                {% endif %}
            </div>

            <div class="attr-box">
                <div class="attr-item"><span class="attr-val">{{ character.forca }}</span><span class="attr-label">FOR</span></div>
                <div class="attr-item"><span class="attr-val">{{ character.agilidade }}</span><span class="attr-label">AGI</span></div>
                <div class="attr-item"><span class="attr-val">{{ character.inteligencia }}</span><span class="attr-label">INT</span></div>
                <div class="attr-item"><span class="attr-val">{{ character.resistencia }}</span><span class="attr-label">RES</span></div>
                <div class="attr-item" style="grid-column: span 2;"><span class="attr-val">{{ character.carisma }}</span><span class="attr-label">CARISMA</span></div>
            </div>

            <div class="section-title" style="margin-top: 30px;">MOMENTUM: <span id="mom-status">INATIVO</span></div>
            <div style="display: flex; gap: 4px; margin-bottom: 5px;">
                <div class="mom-slot" id="mom-1" onclick="updateMomentum(1)"></div>
                <div class="mom-slot" id="mom-2" onclick="updateMomentum(2)"></div>
                <div class="mom-slot" id="mom-3" onclick="updateMomentum(3)"></div>
                <div class="mom-slot" id="mom-4" onclick="updateMomentum(4)"></div>
                <div class="mom-slot" id="mom-5" onclick="updateMomentum(5)"></div>
                <div class="mom-slot" id="mom-6" onclick="updateMomentum(6)"></div>
                <div class="mom-slot" id="mom-7" onclick="updateMomentum(7)"></div>
                <div class="mom-slot" id="mom-8" onclick="updateMomentum(8)"></div>
                <div class="mom-slot" id="mom-9" onclick="updateMomentum(9)"></div>
                <div class="mom-slot" id="mom-10" onclick="updateMomentum(10)"></div>
            </div>
            <p style="font-size: 0.6rem; color: #666; font-family: 'Orbitron'; text-align: center; margin-bottom: 20px;">CHARGE: <span id="mom-val">0</span>/10</p>

            <div class="section-title" style="color: var(--red); border-left-color: var(--red);">RUPTURA DE LIMITE</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <div class="slot-fuso" onclick="toggleRuptura(1)" id="slot-1"></div>
                <div class="slot-fuso" onclick="toggleRuptura(2)" id="slot-2"></div>
                <div class="slot-fuso" onclick="toggleRuptura(3)" id="slot-3"></div>
            </div>
            <button type="button" id="btn-ruptura" class="btn-ruptura-ready" onclick="ativarRuptura()">
                TRANSCENDER
            </button>
            <p style="font-size: 0.6rem; color: #500; font-family: 'Orbitron'; text-align: center; margin-top: 5px;">OVER POWER</p>
        </div>

        <div class="info-col">
            <div class="section-title">STATUS</div>

            <div class="bar-container">
                <div class="bar-info"><span>INTEGRIDADE</span><span>{{ character.vida }}%</span></div>
                <div class="bar-bg"><div class="bar-fill" style="width: {{ character.vida }}%; background: var(--red); box-shadow: 0 0 10px var(--red);"></div></div>
            </div>

            <div class="bar-container">
                <div class="bar-info"><span>ESFOR√áO</span><span>{{ character.esforco }}%</span></div>
                <div class="bar-bg"><div class="bar-fill" style="width: {{ character.esforco }}%; background: var(--blue); box-shadow: 0 0 10px var(--blue);"></div></div>
            </div>

            <div class="bar-container">
                <div class="bar-info"><span>DEFESA / ESQUIVA</span><span>{{ character.defesa_esquiva }} / 50</span></div>
                <div class="bar-bg">
                    <div class="bar-fill" style="width: {% widthratio character.defesa_esquiva 50 100 %}%; background: var(--purple); box-shadow: 0 0 10px var(--purple);"></div>
                </div>
            </div>

            <div class="section-title">EQUIPAMENTO DE COMBATE</div>
            <div class="attr-card" style="background: rgba(0, 162, 255, 0.05); border: 1px solid var(--blue); padding: 15px; display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 1.5rem; color: var(--blue);">‚öîÔ∏è</div>
                <div>
                    <div style="font-size: 0.7rem; color: var(--blue); text-transform: uppercase; font-family: 'Orbitron';">Armamento Ativo</div>
                    <div style="font-family: 'Orbitron'; font-size: 1.1rem; color: #fff;">{{ character.get_arma_display }}</div>
                </div>
            </div>

            <div class="section-title">PER√çCIAS</div>
            <div class="tags-container">
                {% for p in character.pericias.all %} <span class="tag">{{ p.nome }}</span> {% endfor %}
            </div>

            <div class="section-title" style="color: var(--purple); border-left-color: var(--purple);">HABILIDADES ADQUIRIDAS</div>
            <div class="tags-container">
                {% for h in character.habilidades.all %}
                    <span class="tag hab" onclick="showSkill('{{ h.nome|escapejs }}', '{{ h.descricao|escapejs }}')">{{ h.nome }}</span>
                {% endfor %}
            </div>

            <div id="skill-detail-box">
                <div style="font-family: 'Orbitron'; color: var(--purple); font-size: 0.8rem; margin-bottom: 5px; letter-spacing: 2px;" id="skill-title"></div>
                <div id="skill-desc" style="font-family: 'Courier New', monospace; color: #fff; font-size: 0.9rem; border-left: 2px solid var(--purple); padding-left: 10px;"></div>
            </div>

            <div class="section-title" style="color: {{ character.indole.cor|default:'var(--green)' }}; border-left-color: {{ character.indole.cor|default:'var(--green)' }};">
                √çNDOLE: {{ character.indole.nome|upper|default:"N√ÉO DEFINIDA" }}
            </div>
            <div class="class-skill-box" style="border-color: {{ character.indole.cor|default:'var(--green)' }}; background: {{ character.indole.cor|default:'var(--green)' }}1a;">
                {% if character.indole %}
                    <div style="font-family: 'Courier New', monospace; font-size: 0.85rem;">
                        {{ character.indole.descricao|linebreaks }}
                    </div>
                {% else %}
                    <span style="color: #666;">> ALERTA: Nenhuma √≠ndole vinculada ao protocolo.</span>
                {% endif %}
            </div>

            <div class="section-title" style="color: var(--purple);">TRILHA: {{ character.trilha.nome|upper|default:"N√ÉO DEFINIDA" }}</div>
            <div class="trilha-area">
                {% if character.trilha %}
                    {{ character.trilha.descricao|linebreaks }}
                {% else %}
                    <p style="color: var(--red);">> ALERTA: Nenhuma trilha vinculada.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="action-btns">
        <a href="{% url 'home' %}" class="btn" style="border-color: #444; color: #888;">VOLTAR</a>
        <a href="{% url 'character_update' character.pk %}" class="btn btn-edit">MODIFICAR PROTOCOLO</a>
        <a href="{% url 'character_delete' character.pk %}" class="btn btn-del" onclick="return confirm('Deseja deletar?')">DELETAR</a>
    </div>
</div>

<script>
let cargasRuptura = 0;
let currentMomentum = {{ character.momentum|default:0 }};

function initBars() {
    updateMomentum(currentMomentum);
}

// FUN√á√ÉO PARA MOSTRAR DESCRI√á√ÉO DA HABILIDADE
function showSkill(nome, desc) {
    const box = document.getElementById('skill-detail-box');
    const title = document.getElementById('skill-title');
    const text = document.getElementById('skill-desc');

    title.innerText = nome.toUpperCase();
    text.innerText = desc;
    box.style.display = 'block';
    box.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function updateMomentum(n) {
    currentMomentum = n;
    const statusTxt = document.getElementById('mom-status');
    const valTxt = document.getElementById('mom-val');
    for(let i=1; i<=10; i++) {
        document.getElementById(`mom-${i}`).classList.toggle('mom-fill', i <= n);
    }
    if (n >= 8) statusTxt.innerText = "M√ÅXIMO";
    else if (n >= 5) statusTxt.innerText = "ALTO";
    else if (n >= 1) statusTxt.innerText = "ATIVO";
    else statusTxt.innerText = "INATIVO";
    valTxt.innerText = n;
}

function scanAmbiente() {
    const eventos = [
        { t: "VAZAMENTO T√ìXICO", d: "G√°s venenoso! Teste de RESIST√äNCIA. Falha: -15 de Vida." },
        { t: "CURTO-CIRCUITO", d: "Pain√©is explodindo! Teste de AGILIDADE. Falha: -10 de Esfor√ßo." },
        { t: "INTERFER√äNCIA E.M.P.", d: "Pulso eletromagn√©tico! Teste de INTELIG√äNCIA. Falha: Habilidades bloqueadas." },
        { t: "ESTRUTURA INST√ÅVEL", d: "O teto est√° cedendo! Teste de FOR√áA para n√£o ser esmagado." },
        { t: "MULTID√ÉO EM P√ÇNICO", d: "Civis correndo! Teste de CARISMA para n√£o perder o Momentum." }
    ];
    const sorteio = eventos[Math.floor(Math.random() * eventos.length)];
    const box = document.getElementById('scanner-result');
    const texto = document.getElementById('evento-texto');
    box.style.display = 'block';
    texto.innerHTML = `<strong>${sorteio.t}:</strong> ${sorteio.d}`;
    box.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function toggleRuptura(n) {
    cargasRuptura = (cargasRuptura === n) ? n - 1 : n;
    for(let i=1; i<=3; i++) {
        document.getElementById(`slot-${i}`).classList.toggle('slot-ativo', i <= cargasRuptura);
    }
    document.getElementById('btn-ruptura').style.display = (cargasRuptura >= 3) ? 'block' : 'none';
}

function ativarRuptura() {
    const habilidadesOP = [
        { t: "üåå COLAPSO DE SINGULARIDADE", d: "O her√≥i distorce o espa√ßo. O pr√≥ximo ataque atinge TODOS os inimigos com dano cr√≠tico autom√°tico." },
        { t: "‚è≥ REBOBINAGEM TEMPORAL", d: "Recupere TODA a Vida e Esfor√ßo perdidos nos √∫ltimos 2 turnos e resete seus cooldowns." },
        { t: "üëπ MODO BERSERKER (OVERCLOCK)", d: "Dano TRIPLICADO pelos pr√≥ximos 3 turnos, mas voc√™ n√£o pode usar Defesa ou Esquiva." }
    ];
    const sorteio = habilidadesOP[Math.floor(Math.random() * habilidadesOP.length)];
    const box = document.getElementById('ruptura-result');
    const texto = document.getElementById('ruptura-texto');
    box.style.display = 'block';
    texto.innerHTML = `<strong>${sorteio.t}</strong>: ${sorteio.d}`;
    setTimeout(() => {
        cargasRuptura = 0;
        for(let i=1; i<=3; i++) document.getElementById(`slot-${i}`).classList.remove('slot-ativo');
        document.getElementById('btn-ruptura').style.display = 'none';
    }, 100);
    box.scrollIntoView({ behavior: 'smooth', block: 'center' });
}
</script>

</body>
</html>